<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Optimization Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }

        .performance-metrics {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .metric {
            display: inline-block;
            margin-right: 20px;
            padding: 5px 10px;
            background: #e9ecef;
            border-radius: 4px;
        }

        .metric-value {
            font-weight: bold;
            color: #0d6efd;
        }

        .test-table {
            max-height: 400px;
            overflow-y: auto;
        }

        .loading-indicator {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }

        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }

        #resultsItemsBody {
            contain: layout style paint;
        }

        #resultsItemsBody tr {
            will-change: transform;
            transition: background-color 0.15s ease-in-out;
        }
    </style>
</head>

<body>
    <div class="test-container">
        <h2>Test Results Table Performance Test</h2>

        <div class="performance-metrics">
            <h5>Performance Metrics</h5>
            <div class="metric">
                <span>Render Time: </span>
                <span class="metric-value" id="renderTime">-</span>
            </div>
            <div class="metric">
                <span>Data Load Time: </span>
                <span class="metric-value" id="dataLoadTime">-</span>
            </div>
            <div class="metric">
                <span>Cache Hits: </span>
                <span class="metric-value" id="cacheHits">0</span>
            </div>
            <div class="metric">
                <span>Rows Rendered: </span>
                <span class="metric-value" id="rowCount">0</span>
            </div>
        </div>

        <div class="d-flex gap-2 mb-3">
            <button class="btn btn-primary" onclick="testSmallDataset()">Test Small Dataset (10 rows)</button>
            <button class="btn btn-info" onclick="testMediumDataset()">Test Medium Dataset (50 rows)</button>
            <button class="btn btn-warning" onclick="testLargeDataset()">Test Large Dataset (200 rows)</button>
            <button class="btn btn-secondary" onclick="clearTable()">Clear Table</button>
        </div>

        <div class="card">
            <div class="card-header">
                <h5>Test Results Table</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive test-table">
                    <table class="table table-sm table-striped align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Category</th>
                                <th>Value</th>
                                <th>UOM</th>
                                <th>Ref Range</th>
                                <th>Remark</th>
                            </tr>
                        </thead>
                        <tbody id="resultsItemsBody">
                            <tr>
                                <td colspan="5" class="text-center text-muted">Click a test button to load data</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="mt-4">
            <h5>Performance Optimizations Implemented:</h5>
            <ul>
                <li><strong>Caching:</strong> Subcategories, reference ranges, and suggestions are cached to avoid
                    repeated API calls</li>
                <li><strong>Parallel Loading:</strong> All data is loaded simultaneously instead of sequentially</li>
                <li><strong>DocumentFragment:</strong> Table rows are built in memory before being added to DOM</li>
                <li><strong>Loading Indicators:</strong> Visual feedback during data loading</li>
                <li><strong>CSS Containment:</strong> Optimized rendering with CSS contain property</li>
                <li><strong>Event Delegation:</strong> Efficient event handling for large datasets</li>
            </ul>
        </div>
    </div>

    <script>
        let cacheHits = 0;
        let subcategoriesCache = new Map();
        let referenceRangesCache = new Map();

        // Simulate API calls with realistic delays
        function simulateApiCall(delay = 100) {
            return new Promise(resolve => setTimeout(resolve, delay));
        }

        function generateTestData(count) {
            const categories = [
                'Hemoglobin', 'White Blood Cells', 'Red Blood Cells', 'Platelets',
                'Glucose', 'Cholesterol', 'Triglycerides', 'HDL', 'LDL',
                'Creatinine', 'Urea', 'Uric Acid', 'Bilirubin', 'ALT', 'AST',
                'Alkaline Phosphatase', 'GGT', 'Albumin', 'Total Protein',
                'Sodium', 'Potassium', 'Chloride', 'Calcium', 'Phosphorus'
            ];

            const units = ['g/dL', '×10³/μL', '×10⁶/μL', '×10³/μL', 'mg/dL', 'mg/dL', 'mg/dL', 'mg/dL', 'mg/dL', 'mg/dL', 'mg/dL', 'mg/dL', 'mg/dL', 'U/L', 'U/L', 'U/L', 'U/L', 'g/dL', 'g/dL', 'mEq/L', 'mEq/L', 'mEq/L', 'mg/dL', 'mg/dL'];

            const data = [];
            for (let i = 0; i < count; i++) {
                data.push({
                    id: i + 1,
                    subcategory_name: categories[i % categories.length],
                    uom: units[i % units.length],
                    ref_range: `${(Math.random() * 10).toFixed(1)} - ${(Math.random() * 20 + 10).toFixed(1)}`
                });
            }
            return data;
        }

        function showTableLoading() {
            document.getElementById('resultsItemsBody').innerHTML =
                '<tr><td colspan="5" class="text-center"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div> Loading test results...</td></tr>';
        }

        function renderTableRows(subcategories) {
            const startTime = performance.now();
            const tbody = document.getElementById('resultsItemsBody');

            // Use DocumentFragment for better performance
            const fragment = document.createDocumentFragment();

            subcategories.forEach((sub) => {
                const row = document.createElement("tr");
                row.setAttribute("data-subcategory-id", sub.id);

                row.innerHTML = `
                    <td>${sub.subcategory_name}</td>
                    <td><input type="text" class="form-control form-control-sm" placeholder="Enter value"></td>
                    <td>${sub.uom}</td>
                    <td>${sub.ref_range}</td>
                    <td><input type="text" class="form-control form-control-sm" placeholder="Enter remark"></td>
                `;

                fragment.appendChild(row);
            });

            // Clear and append all rows at once
            tbody.innerHTML = "";
            tbody.appendChild(fragment);

            const endTime = performance.now();
            const renderTime = endTime - startTime;

            document.getElementById('renderTime').textContent = `${renderTime.toFixed(2)}ms`;
            document.getElementById('rowCount').textContent = subcategories.length;
        }

        async function loadDataWithCache(testId, count) {
            const startTime = performance.now();

            // Check cache first
            let subcategories = subcategoriesCache.get(testId);
            if (!subcategories) {
                // Simulate API call
                await simulateApiCall(50);
                subcategories = generateTestData(count);
                subcategoriesCache.set(testId, subcategories);
            } else {
                cacheHits++;
                document.getElementById('cacheHits').textContent = cacheHits;
            }

            const endTime = performance.now();
            const dataLoadTime = endTime - startTime;
            document.getElementById('dataLoadTime').textContent = `${dataLoadTime.toFixed(2)}ms`;

            return subcategories;
        }

        async function testSmallDataset() {
            showTableLoading();
            const subcategories = await loadDataWithCache('small', 10);
            renderTableRows(subcategories);
        }

        async function testMediumDataset() {
            showTableLoading();
            const subcategories = await loadDataWithCache('medium', 50);
            renderTableRows(subcategories);
        }

        async function testLargeDataset() {
            showTableLoading();
            const subcategories = await loadDataWithCache('large', 200);
            renderTableRows(subcategories);
        }

        function clearTable() {
            document.getElementById('resultsItemsBody').innerHTML =
                '<tr><td colspan="5" class="text-center text-muted">Click a test button to load data</td></tr>';
            document.getElementById('renderTime').textContent = '-';
            document.getElementById('dataLoadTime').textContent = '-';
            document.getElementById('rowCount').textContent = '0';
        }
    </script>
</body>

</html>