<!DOCTYPE html>
<html lang=  "en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUWAJEEWA LABORATORIES - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="dashboard.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">

    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://unpkg.com https://*.supabase.co; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: https:; connect-src 'self' https://*.supabase.co https://cdn.jsdelivr.net; object-src 'none'; base-uri 'self';">


<body>
    <!-- Navigation will be loaded here by nav.js -->

    <!-- Welcome Section -->
    <section class="welcome-section text-center">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h2 class="welcome-text">Welcome back, <span id="username-display">User</span>!</h2>
                    <p class="dashboard-subtitle">Laboratory Management Dashboard</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Dashboard Grid -->
    <section class="dashboard-grid">
        <div class="container">
            <div class="row">
                <!-- Billing -->
                <div class="col-lg-3 col-md-6">
                    <a href="billing.html" class="dashboard-link">
                        <div class="dashboard-tile tile-blue">
                            <span class="tile-bg-svg"></span>
                            <div class="tile-icon"><i class="fas fa-file-invoice-dollar"></i></div>
                            <h3 class="tile-title">Billing</h3>
                            <p class="tile-subtitle">Session Management</p>
                            <p class="tile-description">Schedule and manage laboratory sessions</p>
                            <div class="tile-stat"><i class="fas fa-clock"></i> 24/7 Available</div>
                        </div>
                    </a>
                </div>

                <!-- Report Entry -->
                <div class="col-lg-3 col-md-6">
                    <a href="reportEntry.html" class="dashboard-link">
                        <div class="dashboard-tile tile-green">
                            <span class="tile-bg-svg"></span>
                            <div class="tile-icon"><i class="fas fa-clipboard-list"></i></div>
                            <h3 class="tile-title">Report Entry</h3>
                            <p class="tile-subtitle">Enter Test Results</p>
                            <p class="tile-description">Enter, validate, and print patient test results</p>
                            <div class="tile-stat"><i class="fas fa-clock"></i> Pending Reports</div>
                        </div>
                    </a>
                </div>

                <!-- Test Data -->
                <div class="col-lg-3 col-md-6">
                    <a href="test-management.html" class="dashboard-link">
                        <div class="dashboard-tile tile-purple">
                            <span class="tile-bg-svg"></span>
                            <div class="tile-icon"><i class="fas fa-vial"></i></div>
                            <h3 class="tile-title">Test Data</h3>
                            <p class="tile-subtitle">Manage Lab Tests</p>
                            <p class="tile-description">Configure tests, sub-categories, and reference ranges</p>
                            <div class="tile-stat"><i class="fas fa-check-circle"></i> 99.9% Accuracy</div>
                        </div>
                    </a>
                </div>

                <!-- Patient History -->
                <div class="col-lg-3 col-md-6">
                    <a href="patientHistory.html" class="dashboard-link">
                        <div class="dashboard-tile tile-cyan">
                            <span class="tile-bg-svg"></span>
                            <div class="tile-icon"><i class="fas fa-user-plus"></i></div>
                            <h3 class="tile-title">Patient History</h3>
                            <p class="tile-subtitle">View Patient Records</p>
                            <p class="tile-description">Search and view complete history of patients</p>
                            <div class="tile-stat"><i class="fas fa-database"></i> All Records</div>
                        </div>
                    </a>
                </div>

                <!-- Reference Details -->
                <div class="col-lg-3 col-md-6">
                    <a href="reference-management.html" class="dashboard-link">
                        <div class="dashboard-tile tile-dark">
                            <span class="tile-bg-svg"></span>
                            <div class="tile-icon"><i class="fas fa-users"></i></div>
                            <h3 class="tile-title">Reference Details</h3>
                            <p class="tile-subtitle">Manage Doctors</p>
                            <p class="tile-description">Add, edit, and manage doctor profiles and commissions</p>
                            <div class="tile-stat"><i class="fas fa-user-md"></i> 150+ Doctors</div>
                        </div>
                    </a>
                </div>

                <!-- Center Details -->
                <div class="col-lg-3 col-md-6">
                    <a href="center-management.html" class="dashboard-link">
                        <div class="dashboard-tile tile-orange">
                            <span class="tile-bg-svg"></span>
                            <div class="tile-icon"><i class="fas fa-building"></i></div>
                            <h3 class="tile-title">Center Details</h3>
                            <p class="tile-subtitle">Manage Institutes</p>
                            <p class="tile-description">Handle institute registrations and partnerships</p>
                            <div class="tile-stat"><i class="fas fa-hospital"></i> 25+ Institutes</div>
                        </div>
                    </a>
                </div>

                <!-- Package Management -->
                <div class="col-lg-3 col-md-6">
                    <a href="package-management.html" class="dashboard-link">
                        <div class="dashboard-tile tile-red">
                            <span class="tile-bg-svg"></span>
                            <div class="tile-icon"><i class="fas fa-boxes"></i></div>
                            <h3 class="tile-title">Package Management</h3>
                            <p class="tile-subtitle">Setup Test Packages</p>
                            <p class="tile-description">Create and manage test packages and their pricing</p>
                            <div class="tile-stat"><i class="fas fa-cogs"></i> Custom Packages</div>
                        </div>
                    </a>
                </div>

                <!-- Reports -->
                <div class="col-lg-3 col-md-6">
                    <a href="reports-management.html" class="dashboard-link">
                        <div class="dashboard-tile tile-pink">
                            <span class="tile-bg-svg"></span>
                            <div class="tile-icon"><i class="fas fa-chart-bar"></i></div>
                            <h3 class="tile-title">Reports</h3>
                            <p class="tile-subtitle">Print lab reports</p>
                            <p class="tile-description">Generate and print comprehensive lab reports</p>
                            <div class="tile-stat"><i class="fas fa-file-alt"></i> 1000+ Reports</div>
                        </div>
                    </a>
                </div>

                

                <!-- Admin -->
                <div class="col-lg-3 col-md-6" id="admin-card">
                    <a href="admin-users.html" class="dashboard-link" id="admin-link">
                        <div class="dashboard-tile tile-indigo">
                            <span class="tile-bg-svg"></span>
                            <div class="tile-icon"><i class="fas fa-user-cog"></i></div>
                            <h3 class="tile-title">Admin</h3>
                            <p class="tile-subtitle">Manage Users</p>
                            <p class="tile-description">Add, edit, and delete admin users</p>
                            <div class="tile-stat"><i class="fas fa-shield-alt"></i> Secure Access</div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </section>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Load configuration and services first -->
    <script src="config/config.js"></script>
    <script src="config/supabase.js"></script>
    <script src="js/services/billingService.js"></script>
    <script src="js/services/testService.js"></script>
    <script src="js/services/referenceService.js"></script>
    <script src="js/services/centerService.js"></script>
    <script src="js/services/packageService.js"></script>
    <script src="js/services/reportsService.js"></script>

    <!-- Load main app -->
    <script src="js/app.js"></script>
    <script src="js/nav.js"></script>
    
    <!-- Dashboard specific script -->
    <script>
        // Update username display from session storage and handle role-based access
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const loggedInUser = sessionStorage.getItem('loggedInUser');
                if (loggedInUser) {
                    const userData = JSON.parse(loggedInUser);
                    if (userData && userData.username) {
                        // Update username display
                        const usernameDisplay = document.getElementById('username-display');
                        if (usernameDisplay) {
                            usernameDisplay.textContent = userData.username;
                        }
                        
                        // Handle role-based access control for admin card
                        handleAdminAccess(userData.role);
                    }
                }
            } catch (error) {
                console.warn('Error loading user data for dashboard:', error);
            }
        });

        function handleAdminAccess(userRole) {
            const adminCard = document.getElementById('admin-card');
            const adminLink = document.getElementById('admin-link');
            
            if (!adminCard || !adminLink) {
                console.warn('Admin card elements not found');
                return;
            }

            if (userRole !== 'admin') {
                // User is staff - disable admin access
                adminCard.style.opacity = '0.5';
                adminCard.style.cursor = 'not-allowed';
                adminCard.style.position = 'relative';
                
                // Remove the link functionality
                adminLink.removeAttribute('href');
                adminLink.style.pointerEvents = 'none';
                adminLink.style.textDecoration = 'none';
                
                // Add a disabled overlay
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.1);
                    z-index: 10;
                    cursor: not-allowed;
                    border-radius: 12px;
                `;
                
                // Add click handler to show access denied message
                overlay.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    showAccessDeniedMessage();
                });
                
                adminCard.appendChild(overlay);
                
                // Update the tile description to show access restriction
                const description = adminCard.querySelector('.tile-description');
                if (description) {
                    description.innerHTML = '<i class="fas fa-lock"></i> Admin access required';
                    description.style.color = '#6b7280';
                }
                
                // Update the stat to show restriction
                const stat = adminCard.querySelector('.tile-stat');
                if (stat) {
                    stat.innerHTML = '<i class="fas fa-ban"></i> Access Restricted';
                    stat.style.color = '#ef4444';
                }
            } else {
                // User is admin - ensure full access (in case of role changes)
                adminCard.style.opacity = '1';
                adminCard.style.cursor = 'pointer';
                adminLink.style.pointerEvents = 'auto';
                
                // Remove any existing overlays
                const overlay = adminCard.querySelector('div[style*="position: absolute"]');
                if (overlay) {
                    overlay.remove();
                }
            }
        }

        function showAccessDeniedMessage() {
            // Create and show access denied notification
            const notification = document.createElement('div');
            notification.className = 'alert alert-warning alert-dismissible fade show position-fixed';
            notification.style.cssText = `
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 350px;
                max-width: 500px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            `;

            notification.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-shield-alt me-2" style="font-size: 1.2em;"></i>
                    <div>
                        <strong>Access Denied</strong><br>
                        <small>You need admin privileges to access user management.</small>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(notification);

            // Auto remove after 4 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 4000);
        }
    </script>
</body>

</html>